<section class="mx-auto max-w-5xl px-4 py-6">
  <div>
    <h2 class="text-2xl font-semibold">Editar Aluguel</h2>
    <hr class="my-4 border-muted/30" />

    <mat-card class="p-4 rounded-2xl shadow-sm">
      <form [formGroup]="aluguelForm" (ngSubmit)="editar()">
        <mat-card-header>
          <mat-card-title class="text-lg font-medium">
            Atualize as informações do aluguel
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="mt-6 space-y-4">
          <!-- Condutor -->
          <mat-form-field class="w-full">
            <mat-label>Condutor</mat-label>
            <mat-select formControlName="condutorId">
              @for (condutor of condutores; track condutor.id) {
                <mat-option [value]="condutor.id">{{ condutor.nome }}</mat-option>
              }
            </mat-select>
            @if (condutorId?.errors?.['required']) {
              <mat-error>O condutor é obrigatório.</mat-error>
            }
          </mat-form-field>

          <!-- Grupo de Automóveis -->
          <mat-form-field class="w-full">
            <mat-label>Grupo de Automóveis</mat-label>
            <mat-select formControlName="grupoVeiculoId">
              @for (grupo of gruposVeiculos; track grupo.id) {
                <mat-option [value]="grupo.id">{{ grupo.nome }}</mat-option>
              }
            </mat-select>
            @if (grupoVeiculoId?.errors?.['required']) {
              <mat-error>O grupo de automóveis é obrigatório.</mat-error>
            }
          </mat-form-field>

          <!-- Automóvel -->
          <mat-form-field class="w-full">
            <mat-label>Automóvel</mat-label>
            <mat-select formControlName="veiculoId" [disabled]="!grupoVeiculoId?.value">
              @for (veiculo of veiculosFiltrados; track veiculo.id) {
                <mat-option [value]="veiculo.id">
                  {{ veiculo.marca }} {{ veiculo.modelo }} - {{ veiculo.placa }}
                </mat-option>
              }
            </mat-select>
            @if (veiculoId?.errors?.['required']) {
              <mat-error>O automóvel é obrigatório.</mat-error>
            }
          </mat-form-field>

          <!-- Datas -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full">
              <mat-label>Data de Saída</mat-label>
              <input
                matInput
                formControlName="dataSaida"
                type="text"
                mask="00/00/0000"
                [dropSpecialCharacters]="false"
                placeholder="dd/mm/aaaa"
              />
              @if (dataSaida?.errors?.['required']) {
                <mat-error>A data de saída é obrigatória.</mat-error>
              }
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Retorno</mat-label>
              <input
                matInput
                formControlName="dataRetornoPrevista"
                type="text"
                mask="00/00/0000"
                [dropSpecialCharacters]="false"
                placeholder="dd/mm/aaaa"
              />
              @if (dataRetornoPrevista?.errors?.['required']) {
                <mat-error>A data de retorno é obrigatória.</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Valor de Entrada e Plano -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <mat-form-field class="w-full">
              <mat-label>Valor de Entrada</mat-label>
              <input matInput formControlName="valorGarantia" type="number" />
              <span matTextPrefix>R$&nbsp;</span>
              <mat-hint>Valor fixo de garantia/caução</mat-hint>
            </mat-form-field>

            <mat-form-field class="w-full">
              <mat-label>Plano</mat-label>
              <mat-select formControlName="planoCobrancaId">
                @for (plano of planosCobranca; track plano.id) {
                  <mat-option [value]="plano.id">Plano {{ plano.grupoVeiculoId }}</mat-option>
                }
              </mat-select>
              @if (planoCobrancaId?.errors?.['required']) {
                <mat-error>O plano é obrigatório.</mat-error>
              }
            </mat-form-field>
          </div>

          <!-- Tipo de Plano -->
          <mat-form-field class="w-full">
            <mat-label>Tipo de Plano</mat-label>
            <mat-select formControlName="tipoPlanoSelecionado">
              @for (tipo of tiposPlano; track tipo.value) {
                <mat-option [value]="tipo.value">{{ tipo.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <!-- Taxas e Serviços -->
          <div class="border border-gray-200 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-gray-700 mb-3">Taxas e Serviços</h3>

            <mat-tab-group>
              <mat-tab label="Taxas Selecionadas">
                <div class="py-4 space-y-2">
                  @for (taxa of taxasServicos; track taxa.id; let i = $index) {
                    <mat-checkbox [formControl]="getTaxaControl(i)">
                      {{ taxa.nome }} - {{ taxa.preco | currency: 'BRL' }}
                      @if (taxa.precoFixo) {
                        <span class="text-xs text-gray-500">(Fixo)</span>
                      } @else {
                        <span class="text-xs text-gray-500">(Por dia)</span>
                      }
                    </mat-checkbox>
                  } @empty {
                    <p class="text-sm text-gray-500">Nenhuma taxa disponível</p>
                  }
                </div>
              </mat-tab>

              <mat-tab label="Seguros">
                <div class="py-4 space-y-3">
                  <mat-checkbox formControlName="seguroCliente">
                    Seguro para o Cliente
                  </mat-checkbox>
                  <mat-checkbox formControlName="seguroTerceiros">
                    Seguro para Terceiros
                  </mat-checkbox>

                  <mat-form-field class="w-full mt-3">
                    <mat-label>Valor do Seguro por Dia</mat-label>
                    <input matInput formControlName="valorSeguroPorDia" type="number" step="0.01" />
                    <span matTextPrefix>R$&nbsp;</span>
                  </mat-form-field>
                </div>
              </mat-tab>
            </mat-tab-group>
          </div>

          <!-- Km Inicial -->
          <mat-form-field class="w-full">
            <mat-label>Km Inicial</mat-label>
            <input matInput formControlName="kmInicial" type="number" min="0" />
            @if (kmInicial?.errors?.['required']) {
              <mat-error>A quilometragem inicial é obrigatória.</mat-error>
            }
            @if (kmInicial?.errors?.['min']) {
              <mat-error>A quilometragem deve ser maior ou igual a zero.</mat-error>
            }
          </mat-form-field>

          <!-- Valor Total -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <div class="flex justify-between items-center">
              <span class="text-lg font-medium text-gray-700">Valor Total:</span>
              <span class="text-2xl font-bold text-green-600">
                {{ calcularValorTotal() | currency: 'BRL' }}
              </span>
            </div>
            <p class="text-xs text-gray-500 mt-1">
              O valor final será calculado considerando o tipo de veículo, plano selecionado,
              garantia e seguros.
            </p>
          </div>
        </mat-card-content>

        <mat-card-actions align="end" class="flex items-center justify-end gap-3 pt-4">
          <a mat-stroked-button routerLink="/alugueis" class="px-4"> Cancelar </a>

          <button type="submit" [disabled]="aluguelForm.invalid" mat-flat-button class="px-6">
            <mat-icon class="!text-base mr-1">check</mat-icon>
            Gravar
          </button>
        </mat-card-actions>
      </form>
    </mat-card>
  </div>
</section>
